"""
ì „ëµëª…: Cases_v2 (ë§¤ë„ì„¸ ì‹¤ì¢… - Volume Dry-up)
ì„¤ëª…: ì‹ ì €ê°€ ê·¼ì²˜ì—ì„œ ê±°ë˜ëŸ‰ì´ ê¸‰ê°í•˜ë©° ì£¼ê°€ê°€ íš¡ë³´í•˜ëŠ” 'ë°”ë‹¥ ë‹¤ì§€ê¸°' íŒ¨í„´ í¬ì°©
"""
import pandas as pd

def calculate(df, i):
    # 1. ë°ì´í„° ë¶€ì¡±í•˜ë©´ ê´€ë§ (ìµœì†Œ 60ì¼ í•„ìš”)
    if i < 60: return 0, ""

    # ----------------------------------------------------
    # [ì§€í‘œ ê³„ì‚°] ì›ë³¸ ë¡œì§ ìœ ì§€
    # ----------------------------------------------------
    # ë§¤ì¼ ê³„ì‚°í•˜ë©´ ëŠë¦¬ë¯€ë¡œ, ì»¬ëŸ¼ì´ ì—†ì„ ë•Œë§Œ í•œ ë²ˆì— ê³„ì‚°
    if 'Vol_MA_20' not in df.columns:
        df['Vol_MA_20'] = df['Volume'].rolling(window=20).mean()
        df['Recent_Low'] = df['Low'].rolling(window=60).min() # 60ì¼ ì‹ ì €ê°€
        df['Day_Chg'] = df['Close'].pct_change() * 100

    # ----------------------------------------------------
    # [ë°ì´í„° ì¡°íšŒ]
    # ----------------------------------------------------
    today = df.iloc[i]
    
    vol = today['Volume']
    vol_ma_20 = today['Vol_MA_20']
    close = today['Close']
    recent_low = today['Recent_Low']
    day_chg = today['Day_Chg']

    # ----------------------------------------------------
    # [ë§¤ë§¤ ë¡œì§] ì›ë³¸ ì¡°ê±´ ì ìš©
    # ----------------------------------------------------
    # íŒŒë¼ë¯¸í„° (ê¸°ë³¸ê°’ ì ìš©)
    vol_drop_ratio = 0.5   # ê±°ë˜ëŸ‰ì´ í‰ì†Œì˜ 50% ì´í•˜
    price_margin = 1.05    # ì‹ ì €ê°€ ëŒ€ë¹„ 5% ì´ë‚´ (ë°”ë‹¥ê¶Œ)
    
    signal = 0
    reason = ""

    # 1. ì‹ ì €ê°€ ê·¼ì²˜ì¸ê°€? (ë°”ë‹¥ê¶Œ í™•ì¸)
    is_low_area = close <= (recent_low * price_margin)
    
    # 2. ê±°ë˜ëŸ‰ì´ ë§ëëŠ”ê°€? (ë§¤ë„ì„¸ ì‹¤ì¢…)
    is_vol_dry = vol < (vol_ma_20 * vol_drop_ratio)
    
    # 3. ì£¼ê°€ê°€ í­ë½í•˜ì§€ ì•Šê³  ë²„í‹°ëŠ”ê°€? (-3% ì´ìƒ)
    is_stable = day_chg > -3.0

    # [ìµœì¢… íŒë‹¨]
    if is_low_area and is_vol_dry and is_stable:
        signal = 1
        reason = f"ë§¤ë„ì„¸ ì‹¤ì¢… (ê±°ë˜ëŸ‰ {int(vol):,}ì£¼ ê¸‰ê°)"
        print(f"ğŸ¤« [Cases_v2] ë°”ë‹¥ ë‹¤ì§€ê¸° í¬ì°©! ({today['Date']}) - {reason}")

    # ë§¤ë„ ì¡°ê±´ì€ ë°±í…ŒìŠ¤í„°ì˜ ê¸°ë³¸ ë¡œì§(ìµì ˆ/ì†ì ˆ)ì— ë§¡ê¸°ê±°ë‚˜, 
    # í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ signal = -1 ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    return signal, reason